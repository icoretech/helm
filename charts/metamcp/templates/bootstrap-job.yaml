{{- if .Values.bootstrap.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "metamcp.fullname" . }}-bootstrap
  labels:
    {{- include "metamcp.labels" . | nindent 4 }}
    app.kubernetes.io/component: bootstrap
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  backoffLimit: 1
  template:
    metadata:
      labels:
        {{- include "metamcp.labels" . | nindent 8 }}
        app.kubernetes.io/component: bootstrap
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: python:3.12-alpine
          imagePullPolicy: IfNotPresent
          env:
            - name: MODE
              value: {{ default "apply" .Values.bootstrap.mode | quote }}
            - name: ADMIN_USER
              value: {{ default "admin" .Values.bootstrap.admin.username | quote }}
            - name: ADMIN_PASS
              value: {{ default "admin" .Values.bootstrap.admin.password | quote }}
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: SVC
              value: {{ printf "%s.%s.svc.cluster.local" (include "metamcp.fullname" .) .Release.Namespace | quote }}
            - name: FRONTEND_PORT
              value: {{ .Values.service.port | toString | quote }}
          volumeMounts:
            - name: cfg
              mountPath: /cfg
              readOnly: true
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -euo pipefail
              python3 -m pip install --no-cache-dir requests >/dev/null
              python3 /cfg/bootstrap.py
      volumes:
        - name: cfg
          configMap:
            name: {{ include "metamcp.fullname" . }}-bootstrap
{{- end }}
