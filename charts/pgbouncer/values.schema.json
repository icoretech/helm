{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "https://icoretech.github.io/helm/charts/pgbouncer/values.schema.json",
  "title": "pgbouncer values",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "nameOverride": { "type": "string" },
    "fullnameOverride": { "type": "string" },
    "replicaCount": { "type": "integer", "minimum": 1 },
    "kind": { "type": "string", "enum": ["Deployment", "DaemonSet"] },
    "updateStrategy": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "type": { "type": "string", "enum": ["Recreate", "RollingUpdate"] },
        "rollingUpdate": {
          "type": "object",
          "additionalProperties": true,
          "properties": {
            "maxUnavailable": { "oneOf": [{"type": "integer", "minimum": 0}, {"type": "string", "pattern": "^[0-9]+%$"}] },
            "maxSurge": { "oneOf": [{"type": "integer", "minimum": 0}, {"type": "string", "pattern": "^[0-9]+%$"}] }
          }
        }
      }
    },
    "minReadySeconds": { "type": "integer", "minimum": 0 },
    "revisionHistoryLimit": { "type": "integer", "minimum": 0 },
    "imagePullSecrets": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name"],
        "properties": {
          "name": { "type": "string", "minLength": 1 }
        }
      }
    },
    "terminationGracePeriodSeconds": { "type": "integer", "minimum": 0 },
    "image": {
      "type": "object",
      "additionalProperties": false,
      "required": ["repository", "tag", "pullPolicy"],
      "properties": {
        "registry": { "type": "string" },
        "repository": { "type": "string", "minLength": 1 },
        "tag": { "type": "string", "minLength": 1 },
        "pullPolicy": { "type": "string", "enum": ["Always", "IfNotPresent", "Never"] }
      }
    },
    "service": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "port"],
      "properties": {
        "annotations": { "type": "object", "additionalProperties": { "type": ["string", "number", "integer", "boolean"] } },
        "type": { "type": "string", "enum": ["ClusterIP", "NodePort", "LoadBalancer", "ExternalName"] },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "nodePort": { "type": ["integer", "null"], "minimum": 1, "maximum": 65535 },
        "internalTrafficPolicy": { "type": "string", "enum": ["Cluster", "Local"] }
      }
    },
    "podLabels": { "type": "object", "additionalProperties": { "type": "string" } },
    "podAnnotations": { "type": "object", "additionalProperties": { "type": ["string", "number", "integer", "boolean"] } },
    "command": { "type": "array", "items": { "type": "string" } },
    "args": { "type": "array", "items": { "type": "string" } },
    "extraEnvs": { "type": "array", "items": { "type": "object" } },
    "resources": { "type": "object" },
    "nodeSelector": { "type": "object", "additionalProperties": { "type": "string" } },
    "lifecycle": { "type": "object" },
    "tolerations": { "type": "array", "items": { "type": "object" } },
    "affinity": { "type": "object" },
    "priorityClassName": { "type": "string" },
    "runtimeClassName": { "type": "string" },
    "config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "existingAdminSecret": { "type": "string" },
        "adminUserKey": { "type": "string", "minLength": 1 },
        "adminPasswordKey": { "type": "string", "minLength": 1 },
        "adminUser": { "type": "string", "minLength": 1 },
        "adminPassword": { "type": ["string", "null"] },
        "authUser": { "type": ["string", "null"] },
        "authPassword": { "type": ["string", "null"] },
        "databases": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": ["string", "number", "integer", "boolean"] }
          }
        },
        "users": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": ["string", "number", "integer", "boolean"] }
          }
        },
        "pgbouncer": {
          "type": "object",
          "additionalProperties": { "oneOf": [ {"type": "string"}, {"type": "number"}, {"type": "integer"}, {"type": "boolean"} ] }
        },
        "existingUserlistSecret": { "type": "string" },
        "userlist": { "type": "object", "additionalProperties": { "type": "string" } }
      },
      "allOf": [
        {
          "if": { "properties": { "authUser": { "type": "string", "minLength": 1 } }, "required": ["authUser"] },
          "then": { "required": ["authPassword"], "properties": { "authPassword": { "type": "string", "minLength": 1 } } }
        }
      ]
    },
    "shareProcessNamespace": {
      "type": "boolean"
    },
    "securityContext": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allowPrivilegeEscalation": { "type": "boolean" },
        "capabilities": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "drop": { "type": "array", "items": { "type": "string" } },
            "add": { "type": "array", "items": { "type": "string" } }
          }
        },
        "readOnlyRootFilesystem": { "type": "boolean" },
        "runAsNonRoot": { "type": "boolean" },
        "runAsUser": { "type": "integer", "minimum": 0 },
        "runAsGroup": { "type": "integer", "minimum": 0 }
      }
    },
    "extraContainers": { "type": "array", "items": { "type": "object" } },
    "extraInitContainers": { "type": "array", "items": { "type": "object" } },
    "extraVolumeMounts": { "type": "array", "items": { "type": "object" } },
    "extraVolumes": { "type": "array", "items": { "type": "object" } },
    "pgbouncerExporter": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "imagePullSecrets": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name"],
            "properties": { "name": { "type": "string", "minLength": 1 } }
          }
        },
        "podMonitor": { "type": "boolean" },
        "host": { "type": "string", "minLength": 1 },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "database": { "type": "string", "minLength": 1 },
        "sslmode": { "type": "string", "enum": ["disable", "allow", "prefer", "require", "verify-ca", "verify-full"] },
        "connect_timeout": { "type": "integer", "minimum": 1 },
        "servicePort": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "image": {
          "type": "object",
          "additionalProperties": false,
          "required": ["repository", "tag", "pullPolicy"],
          "properties": {
            "registry": { "type": "string" },
            "repository": { "type": "string", "minLength": 1 },
            "tag": { "type": "string", "minLength": 1 },
            "pullPolicy": { "type": "string", "enum": ["Always", "IfNotPresent", "Never"] }
          }
        },
        "log": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "level": { "type": "string", "enum": ["debug", "info", "warn", "error"] },
            "format": { "type": "string", "enum": ["logfmt", "json"] }
          }
        },
        "resources": { "type": "object" },
        "securityContext": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "allowPrivilegeEscalation": { "type": "boolean" },
            "capabilities": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "drop": { "type": "array", "items": { "type": "string" } },
                "add": { "type": "array", "items": { "type": "string" } }
              }
            },
            "readOnlyRootFilesystem": { "type": "boolean" },
            "runAsNonRoot": { "type": "boolean" },
            "runAsUser": { "type": "integer", "minimum": 0 },
            "runAsGroup": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "podDisruptionBudget": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean" },
        "maxUnavailable": { "oneOf": [{"type": "integer", "minimum": 0}, {"type": "string", "pattern": "^[0-9]+%$"}, {"type": "null"}] },
        "minAvailable": { "oneOf": [{"type": "integer", "minimum": 0}, {"type": "string", "pattern": "^[0-9]+%$"}, {"type": "null"}] }
      },
      "allOf": [
        {
          "not": {
            "allOf": [
              {
                "properties": { "maxUnavailable": { "not": { "type": "null" } } },
                "required": ["maxUnavailable"]
              },
              {
                "properties": { "minAvailable": { "not": { "type": "null" } } },
                "required": ["minAvailable"]
              }
            ]
          }
        }
      ]
    },
    "serviceAccount": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string" },
        "annotations": { "type": "object", "additionalProperties": { "type": ["string", "number", "integer", "boolean"] } }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "config": { "properties": { "existingAdminSecret": { "type": "string", "minLength": 1 } }, "required": ["existingAdminSecret"] } }
      },
      "then": {}
    },
    {
      "if": {
        "properties": { "config": { "properties": { "existingAdminSecret": { "type": "string", "maxLength": 0 } } } }
      },
      "then": {
        "properties": {
          "config": {
            "required": ["adminPassword"],
            "properties": { "adminPassword": { "type": ["string"], "minLength": 1 } }
          }
        }
      }
    }
  ]
}
