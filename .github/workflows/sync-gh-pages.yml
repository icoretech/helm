name: Sync README and ArtifactHub to gh-pages

on:
  push:
    branches: [ main ]
    paths:
      - README.md
      - artifacthub-repo.yml
      - signing/**
      - charts/**/logo.*
  workflow_dispatch:

jobs:
  sync:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Sync files into gh-pages
        shell: bash
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git worktree add ghp gh-pages
          else
            echo "gh-pages does not exist; creating orphan branch with minimal files"
            git worktree add ghp -b gh-pages
            pushd ghp >/dev/null
            git rm -rf . || true
            popd >/dev/null
          fi

          cp -v README.md ghp/README.md
          cp -v artifacthub-repo.yml ghp/artifacthub-repo.yml
          if [ -f signing/pgp-public-key.asc ]; then
            cp -v signing/pgp-public-key.asc ghp/pgp-public-key.asc
          fi
          # We intentionally do NOT create .nojekyll because the site uses Jekyll to render index.md

          # Publish per-chart docs and logos for Pages
          shopt -s nullglob
          for d in charts/*; do
            chart_dir="${d#charts/}"
            [ -d "$d" ] || continue
            mkdir -p "ghp/charts/${chart_dir}"
            # Copy README as index.md so /charts/<name>/ resolves
            if [ -f "$d/README.md" ]; then
              tmpfile=$(mktemp)
              # Strip markdownlint comments that can confuse some renderers
              sed '/^<!--\s*markdownlint/Id' "$d/README.md" > "$tmpfile"
              {
                echo "---";
                echo "layout: default";
                echo "title: ${chart_dir}";
                echo "---";
                echo;
                # Ensure a blank line before pipe tables after a Values heading
                awk 'prev~/^##[ ]*Values[ ]*$/ && $0 ~ /^\|/ {print ""} {print; prev=$0}' "$tmpfile"
              } > "ghp/charts/${chart_dir}/index.md"
              rm -f "$tmpfile"
              echo "Wrote ghp/charts/${chart_dir}/index.md with front matter"
            fi
            # Copy logos if present
            for logo in "$d"/logo.*; do
              [ -f "$logo" ] || continue
              cp -v "$logo" "ghp/charts/${chart_dir}/" || true
            done
          done

          pushd ghp >/dev/null
          if [[ -n "$(git status --porcelain)" ]]; then
            git add README.md artifacthub-repo.yml pgp-public-key.asc charts || true
            git commit -m "docs: sync README & artifacthub metadata from main"
            git fetch origin gh-pages
            git rebase origin/gh-pages
            git push origin gh-pages
          else
            echo "No changes to sync."
          fi
          popd >/dev/null

      - name: Cleanup worktree
        if: always()
        run: |
          git worktree remove -f ghp || true
          # Remove local gh-pages branch created for the worktree only
          git branch -D gh-pages || true
